version: '3.8'

services:
  miniapp:
    image: rast53/aitovideo-miniapp:latest
    networks:
      - traefik-net
      - aitovideo-net
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.aitovideo.rule=Host(`${AITOVIDEO_DOMAIN}`)"
        - "traefik.http.routers.aitovideo.entrypoints=websecure"
        - "traefik.http.routers.aitovideo.tls=true"
        - "traefik.http.routers.aitovideo.tls.certresolver=letsencrypt"
        - "traefik.http.services.aitovideo.loadbalancer.server.port=80"
        - "traefik.http.routers.aitovideo.service=aitovideo"
        - "traefik.swarm.network=traefik-net"

  backend:
    image: rast53/aitovideo-backend:latest
    environment:
      - NODE_ENV=production
      - PORT=3000
      - BOT_TOKEN=${BOT_TOKEN}
      - DATABASE_URL=/app/data/videos.db
      - MINI_APP_URL=https://${AITOVIDEO_DOMAIN}
      - VK_SERVICE_TOKEN=${VK_SERVICE_TOKEN:-}
      - YTDLP_PROXY=${YTDLP_PROXY:-}
    volumes:
      - backend-data:/app/data
    networks:
      - aitovideo-net
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  bot:
    image: rast53/aitovideo-backend:latest
    command: ["node", "dist/bot/index.js"]
    environment:
      - NODE_ENV=production
      - BOT_TOKEN=${BOT_TOKEN}
      - API_URL=http://backend:3000
      - MINI_APP_URL=https://${AITOVIDEO_DOMAIN}
      - VK_SERVICE_TOKEN=${VK_SERVICE_TOKEN:-}
    networks:
      - aitovideo-net
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

volumes:
  backend-data:
    driver: local

networks:
  traefik-net:
    external: true
  aitovideo-net:
    driver: overlay
